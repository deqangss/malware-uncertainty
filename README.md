# Uncertainty Quantification for Android Malware Detectors

This code repository is for the ongoing paper, entitled **An Empirical Study on Quantifying Uncertainty of Deep Malware Detectors**.
 
## Overview
Our aim to explore the uncertainty quantification to harden malware detectors in the realistic environments. 
This approach is merely exploited in the context of malware detection. 
Therefore we evaluate the quality of predictive uncertainties of malware detectors in the presence or absence of concept drift. 
Specifically, we use 3 Android malware detectors, including [DeepDrebin](http://patrickmcdaniel.org/pubs/esorics17.pdf), [MultimodalNN](https://ieeexplore.ieee.org/document/8443370) and [DeepDroid](https://dl.acm.org/doi/10.1145/3029806.3029823), and 6 calibration methods, including [Vanilla](https://arxiv.org/abs/1906.02530), [Temp scaling](https://arxiv.org/abs/1706.04599), [Monto Carlo dropout](https://arxiv.org/abs/1506.02142), [variational Bayesian Inference](https://arxiv.org/abs/1906.02530), [Deep Ensemble](https://arxiv.org/abs/1612.01474) and Weighted deep ensemble.
The concept drift is specified as *out of source*, *covariate shift* or *adversarial evasion attacks*.

## Dependencies:
We develop the codes on Windows operation system, and run the codes on Ubuntu 18.04. The codes depend on Python 3.6. All the packages (e.g., TensorFlow) can be found in the `./requirements.txt`.

## Configuration & Usage
#### 1. Datasets
* Three datasets are leveraged, namely that [Drebin](https://www.sec.cs.tu-bs.de/~danarp/drebin/), [VirusShare_Android_APK_2013](https://virusshare.com/) and [Androzoo](https://androzoo.uni.lu/). 
Note that for the security consideration, these three datasets are required to follow the policies of their own to obtain the apks. 

&emsp; For Drebin, we can download the malicious APKs from the official website and we provides sha256 codes of a portion of Drebin benign APKs, for which the corresponding APKs can be download from [Androzoo](https://androzoo.uni.lu/). 

&emsp; For Androzoo, we use the dataset built by researchers [Pendlebury et al.](https://www.usenix.org/conference/usenixsecurity19/presentation/pendlebury) All APKs can be downloaded from Androzoo.

&emsp; For Virusshare, we use the file named `VirusShare_Android_APK_2013.zip`. 

&emsp; For adversarial APKs, we resort to this [repository](https://github.com/deqangss/adv-dnn-ens-malware). 

* We additionally provide the preprocessed data files which are available at an anonymous [url](https://mega.nz/folder/bF8RQAAI#HeIhpUzDdqCdWdh4bAIZbg) (the size of unzip folder is ~213GB). 

#### 2. Configure
For convenience, we provide a `conf` file to assist the customization. Before running, all things are changed in the following:
* Modify the `project_root=/absolute/path/to/malware-uncertainty/`. 

* Modify the `database_dir=/absolute/path/to/datasets`. For more details (Optionally), there are `Drebin` or `Androzoo` malware datasets in this directory with the structure:
```
datasets
|---drebin
      |---malicious_samples  % malicious apps folder
      |---benign_samples     % benign apps foler
|---androzoo_tesseract
      |---malicious_samples
      |---benign_samples
      |   date_stamp.json    % date stamp for each app, we will provide
|---VirusShare_Android_APK_2013
      |---malicious_samples
      |---benign_samples
|---naive_data               % saving the preprocessed data files 
...
```
If no real apps are considered, the preprocessing data files make the project work as well. In this case, we continue to config the followings:
* Download the `datasets` from the anonymous [url](https://mega.nz/folder/bF8RQAAI#HeIhpUzDdqCdWdh4bAIZbg), and put the folder in the project root directory, namely `malware-uncertainty`. Please Note that this `datasets` is not necessary the same as the directory of `database_dir` in the second step. 
* Download the `naive_data` from the anonymous [url](https://mega.nz/folder/bF8RQAAI#HeIhpUzDdqCdWdh4bAIZbg), and put the folder in the `database_dir` directory, which is configured in the second step (need unzip, `mv naive_data.tar.gz database_dir; cd database_dir; tar -xvzf naive_data.tar.gz ./`).

#### 3. Usage
* For training, all scripts are listed in `./run.sh`
* Then for producing figures and table data, the python code is `./experiments/table-figures.py`

## License && Issues

We will make our codes public available under a formal license. For now, this is still an ongoing work. We are accommodating the following two issues:
* No random seed set for friendly reproducing
* The training, validation, and test datasets are split randomly, leading to a mess of results.






 

